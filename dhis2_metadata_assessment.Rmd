---
title: "DHIS2 Metadata Assessment"
author: "DHIS2 Implementation Team"
date: "`r Sys.Date()`"
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
require(jsonlite)
require(httr)
require(purrr)
require(knitr)
require(magrittr)
require(ggplot2)

#Modify login details to the server as needed
baseurl <- Sys.getenv("baseurl")
username <- Sys.getenv("username")
password <- Sys.getenv("password")


dhis_views <- jsonlite::read_json("sql_views.json")

views_uids <- dhis_views %>% 
  purrr::pluck("sqlViews") %>%
  purrr::map( ~ .x$id) %>% 
  unlist()

views_names <- dhis_views %>% 
  purrr::pluck("sqlViews") %>%
  purrr::map( ~ .x$name) %>% 
  unlist()


views_descriptions <- dhis_views %>% 
  purrr::pluck("sqlViews") %>%
  purrr::map( ~ .x$description) %>% 
  unlist()

views <-data.frame(id=views_uids,name=views_names,description=views_descriptions,stringsAsFactors = FALSE)

#Login to the server
d2_session <- httr::handle(baseurl)
me <-httr::GET(paste0(baseurl,"api/me"), authenticate(username,password), handle= d2_session)

if (!me$status_code == 200L) {
  stop("Could not login to DHIS2")
}

uploadMetadata <- function(payload, d2_session) {
  url <-paste0(d2_session$url,"api/metadata")
  r <- httr::POST(url = url,
             body = jsonlite::toJSON(payload,auto_unbox = TRUE),
             content_type_json(),
             handle = d2_session)
  return(r$status_code)
}

r <- uploadMetadata(dhis_views, d2_session)
if (r != 200L) {
  stop("Could not upload metadata!")
}

getSQLView <- function(uid,d2_session) {
  
  # #Execute the view first to be sure its fresh
  # url <- paste0(d2_session$url,"api/sqlViews/",uid,"/execute")
  # r <- httr::POST(url,content_type_json(), handle = d2_session)
  # if (r$status_code != 201L) {
  #   warning(paste0("Could not execute view ",uid))
  #   return(data.frame())
  # }
  
  resp  <- httr::GET(paste0(d2_session$url,"api/sqlViews/",uid,"/data.json"), handle=d2_session) %>% 
    httr::content("text") %>% 
    jsonlite::fromJSON(.)
  headers <- resp$listGrid$headers$column
  
  df <- as.data.frame(resp$listGrid$rows,stringsAsFactors = FALSE)
  
  colnames(df) <- headers
  return(df)
}


getDetailsUID <- function(name,views) {
  new_name <- stringr::str_replace(name,"_S","_D")
  dplyr::filter(views,name == new_name) %>% 
    dplyr::pull(id)
}

```

# Metadata issues

```{r sql_view_results, echo=FALSE,message=FALSE,results="asis"}

summary_views <- views %>% 
  dplyr::filter(stringr::str_detect(name,"_S$"))

for (i in seq_len(NROW(summary_views))) {
  
  r <- getSQLView(summary_views$id[i],d2_session = d2_session)
  cat("\n")
  cat(paste("-",summary_views$description[i]),":",r$value, "issues found. (", r$percent,")")
  cat("\n")
  details_id <- getDetailsUID(summary_views$name[i],views)
  cat(paste0("[Dowload details](",baseurl,"api/sqlViews/",details_id,"/data.csv)"))
  cat("\n")

  }

```

# Users

```{r users, echo=FALSE,message=FALSE}

url <- paste0(d2_session$url,"api/users?paging=false&fields=userCredentials[*]")
r <-httr::GET(url,content_type_json(),handle=d2_session) %>% 
  httr::content(.,"text") %>% 
  jsonlite::fromJSON()

n_users <- length(r$users$userCredentials)
last_logins <- strptime(r$users$userCredentials$lastLogin,"%Y-%m-%dT%H:%M:%S") 
last_login_age <- difftime(Sys.time(),last_logins,units="days")

```

- Total users: `r NROW(r$users$userCredentials)`
- Total users logged in within 7 days: `r sum(last_login_age <= 7,na.rm = TRUE)`
- Total users logged in within 30 days: `r sum(last_login_age <= 30,na.rm = TRUE)`
- Total users logged in within 90 days: `r sum(last_login_age <= 90,na.rm = TRUE)`
- Total users logged in within a year: `r sum(last_login_age <= 365,na.rm = TRUE)`
- Users who have never logged in: `r sum(is.na(last_login_age))`



```{r users_histogram,  echo=FALSE,message=FALSE, warning=FALSE}

qplot(as.numeric(last_login_age), 
geom="histogram",
main="User login age by day",
xlab="Days since last logged in",
ylab="Count")

```
