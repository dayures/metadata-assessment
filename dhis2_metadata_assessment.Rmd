---
title: "DHIS2 Metadata Assessment"
author: "DHIS2 Implementation Team"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
always_allow_html: yes
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}

if (!require("pacman")) install.packages("pacman")
pacman::p_load(jsonlite, httr, purrr,knitr,magrittr,ggplot2,DT,dplyr,yaml,knitr,rmarkdown,dplyr,readr)

source("R/utils.R")
#Modify login details to the server as needed
baseurl <- Sys.getenv("baseurl")
username <- Sys.getenv("username")
password <- Sys.getenv("password")


views <- transformYAMLtoControlFile()

metadata <- transformYAMLtoMetadata()

#Login to the server
d2_session <- httr::handle(baseurl)
me <-httr::GET(paste0(baseurl,"api/me"), authenticate(username,password), handle= d2_session)

if (!me$status_code == 200L) {
  stop("Could not login to DHIS2")
}

 r <- uploadMetadata(metadata, d2_session)
 if (r$status_code != 200L) {
   stop("Could not upload metadata!")
 }


```

# Target server: `r baseurl`

## Metadata issues

```{r sql_view_results, echo=FALSE,message=FALSE,results="asis"}

summary_views <- views$summary_uid


results <- data.frame(indicator = character(),
                      value = character(),
                      percent = character(),
                      description = character(),
                      stringsAsFactors = FALSE)

for (uid in summary_views) {
  r <- getSQLView(uid,d2_session = d2_session)
  results <- dplyr::bind_rows(r,results)
}


results<-results %>% 
  dplyr::left_join(views[,c("summary_uid","section","section_order","details_uid")] , by =c("uid"="summary_uid")) %>% 
  dplyr::arrange(section,section_order) %>%
  dplyr::mutate("Details" = paste0("<a href='",d2_session$url,"api/sqlViews/",details_uid,"/data.csv'>Details</a>")) %>% 
  dplyr::select( "Theme" = section,
    "Issue" = description,
                "Count" = value,
                "Percentage" = percent,
    Details)
#Remove the views if requested to
if (Sys.getenv("cleanup_views") == TRUE) {
  r <- deleteMetadata(metadata, d2_session)
}

DT::datatable(results,escape = FALSE)

```

## Users

```{r users, echo=FALSE,message=FALSE}

url <- paste0(d2_session$url,"api/users?paging=false&fields=userCredentials[*]")
r <-httr::GET(url,content_type_json(),handle=d2_session) %>% 
  httr::content(.,"text") %>% 
  jsonlite::fromJSON()

n_users <- length(r$users$userCredentials)
last_logins <- strptime(r$users$userCredentials$lastLogin,"%Y-%m-%dT%H:%M:%S") 
last_login_age <- difftime(Sys.time(),last_logins,units="days")

```

- Total users: `r NROW(r$users$userCredentials)`
- Total users logged in within 7 days: `r sum(last_login_age <= 7,na.rm = TRUE)`
- Total users logged in within 30 days: `r sum(last_login_age <= 30,na.rm = TRUE)`
- Total users logged in within 90 days: `r sum(last_login_age <= 90,na.rm = TRUE)`
- Total users logged in within a year: `r sum(last_login_age <= 365,na.rm = TRUE)`
- Users who have never logged in: `r sum(is.na(last_login_age))`



```{r users_histogram,  echo=FALSE,message=FALSE, warning=FALSE}

qplot(as.numeric(last_login_age), 
geom="histogram",
main="User login age by day",
xlab="Days since last logged in",
ylab="Count")

```
