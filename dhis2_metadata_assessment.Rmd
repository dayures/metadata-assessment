---
title: "DHIS2 Metadata Assessment"
author: "DHIS2 Implementation Team"
date: "`r Sys.Date()`"
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
require(jsonlite)
require(httr)
require(purrr)
require(knitr)
require(magrittr)
require(ggplot2)

#Modify login details to the server as needed
baseurl <- "https://play.dhis2.org/2.36.3/"
username <- "admin"
password <- "district"


dhis_views <- jsonlite::read_json("test_metadata_assessment_sqlviews.json")

views_uids <- dhis_views %>% 
  purrr::pluck("sqlViews") %>%
  purrr::map( ~ .x$id) %>% 
  unlist()

views_names <- dhis_views %>% 
  purrr::pluck("sqlViews") %>%
  purrr::map( ~ .x$name) %>% 
  unlist()


#Login to the server
d2_session <- httr::handle(baseurl)
me <-httr::GET(paste0(baseurl,"api/me"), authenticate(username,password), handle= d2_session)

if (!me$status_code == 200L) {
  stop("Could not login to DHIS2")
}

uploadMetadata <- function(payload, d2_session) {
  url <-paste0(d2_session$url,"api/metadata")
  r <- httr::POST(url = url,
             body = jsonlite::toJSON(payload,auto_unbox = TRUE),
             content_type_json(),
             handle = d2_session)
  return(r$status_code)
}

r <- uploadMetadata(dhis_views, d2_session)
if (r != 200L) {
  stop("Could not upload metadata!")
}

getSQLView <- function(uid,d2_session) {
  
  #Execute the view first to be sure its fresh
  url <- paste0(d2_session$url,"api/sqlViews/",uid,"/execute")
  r <- httr::POST(url,content_type_json(), handle = d2_session)
  if (r$status_code != 201L) {
    warning(paste0("Could not execute view ",uid))
    return(data.frame())
  }
  
  resp  <- httr::GET(paste0(d2_session$url,"api/sqlViews/",uid,"/data.json"), handle=d2_session) %>% 
    httr::content("text") %>% 
    jsonlite::fromJSON(.)
  headers <- resp$listGrid$headers$column
  
  df <- as.data.frame(resp$listGrid$rows,stringsAsFactors = FALSE)
  
  colnames(df) <- headers
  return(df)
}

```

# Metadata issues

```{r sql_view_results, echo=FALSE,message=FALSE,results="asis"}

for (i in seq_along(views_uids)) {
  r <- getSQLView(views_uids[i],d2_session = d2_session)
  
  cat("\n")
  cat(paste("-",views_names[i]),":",NROW(r), "issues found.")
  cat("\n")
  cat(paste0("[Dowload details](",baseurl,"api/sqlViews/",views_uids[i],"/data.csv)"))
  cat("\n")

  }

```

# Users

```{r users, echo=FALSE,message=FALSE}

url <- paste0(d2_session$url,"api/users?paging=false&fields=userCredentials[*]")
r <-httr::GET(url,content_type_json(),handle=d2_session) %>% 
  httr::content(.,"text") %>% 
  jsonlite::fromJSON()

n_users <- length(r$users$userCredentials)
last_logins <- strptime(r$users$userCredentials$lastLogin,"%Y-%m-%dT%H:%M:%S") 
last_login_age <- difftime(Sys.time(),last_logins,units="days")
```

- Total users: `r NROW(r$users$userCredentials)`
- Total users logged in within 7 days: `r sum(last_login_age <= 7,na.rm = TRUE)`
- Total users logged in within 30 days: `r sum(last_login_age <= 30,na.rm = TRUE)`
- Total users logged in within 90 days: `r sum(last_login_age <= 90,na.rm = TRUE)`
- Total users logged in within a year: `r sum(last_login_age <= 365,na.rm = TRUE)`
- Users who have never logged in: `r sum(is.na(last_login_age))`



```{r users_histogram,  echo=FALSE,message=FALSE, warning=FALSE}
qplot(as.numeric(last_login_age), 
geom="histogram",
main="User login age by day",
xlab="Days since last logged in",
ylab="Count")

```
