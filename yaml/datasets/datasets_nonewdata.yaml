# Copyright (c) 2021, University of Oslo
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
# Redistributions of source code must retain the above copyright notice, this
# list of conditions and the following disclaimer.
#
# Redistributions in binary form must reproduce the above copyright notice,
# this list of conditions and the following disclaimer in the documentation
# and/or other materials provided with the distribution.
# Neither the name of the HISP project nor the names of its contributors may
# be used to endorse or promote products derived from this software without
# specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
# ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
# ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
---
  summary_uid: zTcgbu3oLa7
  name: dataset_nonewdata
  description: Data sets with no data values in the last 3 periods (based on data set period type).
  section: Datasets
  section_order: 3
  summary_sql: >-
    with ds_lastupdate as (select datasetid, avg(date_part('day',
    pe.enddate::timestamp - pe.startdate::timestamp))::int as interval
    from dataset ds
    left join period pe using(periodtypeid) group by datasetid),
    ds_period as (select datasetid, dataelementid, periodid from dataset ds
    left join period pe using(periodtypeid)
    left join datasetelement using(datasetid)
    where date_part('day', now() -
    pe.enddate::timestamp)::int <= 3*date_part('day',
    pe.enddate::timestamp - pe.startdate::timestamp)::int)
    select 'dataset_nonewdata' as indicator,
    count(*)::varchar as value,
    (100*count(*)/(select count(*) from dataset))::varchar || '%' as percent,
    'Data sets with no data values in
    the last 3 periods (based on data set period type).' as description
    from dataset
    where datasetid not in
    (select distinct datasetid from ds_period
    where (dataelementid,periodid) in (select dataelementid,
    periodid from datavalue) group by datasetid);
  details_uid: N4z01NXIcir
  details_sql: >-
    with ds_lastupdate as (select datasetid, avg(date_part('day',
    pe.enddate::timestamp - pe.startdate::timestamp))::int as interval
    from dataset ds
    left join period pe using(periodtypeid) group by datasetid),
    ds_period as (select datasetid, dataelementid, periodid from dataset ds
    left join period pe using(periodtypeid)
    left join datasetelement using(datasetid)
    where date_part('day', now() -
    pe.enddate::timestamp)::int <= 3*date_part('day',
    pe.enddate::timestamp - pe.startdate::timestamp)::int)
    SELECT uid,name from dataset
    where datasetid not in
    (select distinct datasetid from ds_period
    where (dataelementid,periodid) in (select dataelementid,
    periodid from datavalue) group by datasetid);
  severity: WARNING
  introduction: >
    All active datasets should have data values associated with them.
    Active data sets are data sets which should be currently used
    (this is defined as within the last 3 reporting periods) to collect data.
  recommendation: >
    * If a data set is not being updated with new data or no new data values
    are being entered within the last 3 periods (relative to the period type
    assigned to the dataset ex. monthly will be the last 3 months, quarterly the last 3 quarters)
    against the dataset but there are data values from previous periods the data set
    should be archived (ie. assign it a prefix)

    * If a data set has no new or previous data values within the last 3
    periods (relative to the period type assigned to the dataset) and will
    not be used to collect data, the data set should be removed.
